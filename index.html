<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home - Fixed UI State</title>
    <!-- ÂºïÂÖ• MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        /* È°µÈù¢ËÉåÊôØ */
        body { margin: 0; overflow: hidden; background-color: #dcdde1; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        
        /* Âº∫Âà∂ Canvas Â°´Êª°ÂÆπÂô® */
        canvas { display: block; width: 100%; height: 100%; }

        /* --- ‰æßËæπÊ†èÊ†∑Âºè --- */
        .sidebar {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(30px) saturate(120%);
            -webkit-backdrop-filter: blur(30px) saturate(120%);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 10px 0 40px rgba(0,0,0,0.05);
            transform: translateX(-100%);
            z-index: 100;
            padding: 90px 25px 30px 25px;
            box-sizing: border-box;
            display: flex; flex-direction: column; gap: 30px;
            transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
        }
        
        .sidebar.active { transform: translateX(0); }

        .sb-section h3 { 
            font-size: 12px; text-transform: uppercase; letter-spacing: 2px; 
            color: #7f8fa6; margin-bottom: 15px; font-weight: 700; text-shadow: 0 1px 0 rgba(255,255,255,0.5);
        }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-card { 
            background: rgba(255,255,255,0.3); 
            border-radius: 12px; padding: 15px; text-align: center; 
            border: 1px solid rgba(255,255,255,0.4); 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .stat-value { font-size: 24px; font-weight: 600; color: #505050; display: block; }
        .stat-label { font-size: 11px; color: #666; margin-top: 5px; display: block; }
        
        .room-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
        .room-item { 
            padding: 12px 16px; border-radius: 8px; 
            background: rgba(255,255,255,0.1); 
            color: #505050; font-size: 14px; font-weight: 500; 
            cursor: pointer; transition: all 0.2s; 
            display: flex; justify-content: space-between; align-items: center;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .room-item:hover { 
            background: rgba(255,255,255,0.5); 
            transform: translateX(3px); 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .room-item.selected { background: rgba(255,255,255,0.8); border-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .room-icon { opacity: 0.5; font-size: 12px; }

        /* --- ÁÅØÂÖâÊéßÂà∂‰∫åÁ∫ßÈù¢Êùø --- */
        .controls-panel {
            position: fixed; top: 120px; left: 290px;
            width: 240px; 
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            z-index: 90;
            opacity: 0;
            transform: translateX(-20px) scale(0.95);
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: none;
        }

        .controls-panel.active {
            opacity: 1;
            transform: translateX(0) scale(1);
            pointer-events: auto;
        }

        .cp-header { margin-bottom: 20px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .cp-title { margin: 0; font-size: 16px; font-weight: 600; color: #333; }
        .cp-subtitle { margin: 0; font-size: 12px; color: #777; margin-top: 4px; }

        /* ÊéßÂà∂Ë°åÊ†∑ÂºèÔºöÊï¥Ë°åÁÇπÂáª */
        .control-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; padding: 12px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .control-row:hover { background: rgba(255,255,255,0.6); }
        
        /* ÊøÄÊ¥ªÁä∂ÊÄÅÊ†∑Âºè */
        .control-row.active-state { 
            background: #fff; 
            border-color: rgba(76, 217, 100, 0.5);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .control-row.active-state .control-label { color: #4cd964; }
        .control-row.active-state .status-text { color: #4cd964; font-weight: bold; }

        .control-label { font-size: 14px; color: #555; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        
        /* ÂõæÊ†á */
        .icon-light::before { content: "üí°"; font-size: 16px; }

        /* ÈöêËóèÂéüÊúâÁöÑ Switch ÂºÄÂÖ≥ */
        .switch { display: none; }
        .status-text { font-size: 12px; color: #999; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }

        /* --- ‰∏ªÂÜÖÂÆπÂÆπÂô® --- */
        #main-wrapper {
            position: relative; width: 100%; height: 100vh; margin-left: 0;
            background-color: #dcdde1; 
            transition: margin-left 0.6s cubic-bezier(0.16, 1, 0.3, 1), width 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: margin-left, width; overflow: hidden;
        }
        body.sidebar-open #main-wrapper { margin-left: 280px; width: calc(100% - 280px); }

        /* --- UI Êéß‰ª∂ --- */
        .menu-btn {
            position: absolute; top: 30px; left: 30px; z-index: 95;
            width: 42px; height: 42px; border-radius: 12px;
            background: rgba(255,255,255,0.4); border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(8px);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease; color: #505050; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .menu-btn:hover { background: rgba(255,255,255,0.8); transform: scale(1.05); }

        .theme-controls { position: absolute; top: 30px; right: 30px; display: flex; gap: 12px; z-index: 10; }
        .theme-btn { width: 42px; height: 42px; border-radius: 50%; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(8px); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .theme-btn:hover { transform: translateY(-2px); background: rgba(255,255,255,0.5); }
        .theme-btn.active { border-color: #fff; box-shadow: 0 0 0 2px rgba(255,255,255,0.6); transform: scale(1.1); }
        .color-dot { width: 18px; height: 18px; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .view-controls { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.7); padding: 5px 6px; border-radius: 50px; display: flex; gap: 5px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); backdrop-filter: blur(10px); z-index: 10; border: 1px solid rgba(255,255,255,0.4); }
        .view-btn { background: transparent; border: none; color: #718093; padding: 12px 32px; border-radius: 40px; cursor: pointer; font-size: 13px; font-weight: 600; letter-spacing: 1.5px; transition: all 0.4s ease; }
        .view-btn.active { background: #718093; color: #fff; box-shadow: 0 4px 12px rgba(113, 128, 147, 0.3); }
        
        .tip { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); color: #505050; background: rgba(255,255,255,0.7); padding: 10px 24px; border-radius: 30px; font-size: 13px; font-weight: 500; backdrop-filter: blur(10px); pointer-events: none; box-shadow: 0 8px 20px rgba(0,0,0,0.05); transition: all 0.3s ease; z-index: 5; min-width: 240px; text-align: center; }
        
        #mqtt-status { position: fixed; bottom: 10px; right: 10px; font-size: 10px; color: #aaa; z-index: 200; pointer-events: none; }
    </style>
</head>
<body>

    <!-- ‰æßËæπÊ†è -->
    <div class="sidebar" id="sidebar">
        <div class="sb-section">
            <h3>Environment</h3>
            <div class="stats-grid">
                <div class="stat-card"><span class="stat-value" id="val-temp">--</span><span class="stat-label">Temp (¬∞C)</span></div>
                <div class="stat-card"><span class="stat-value" id="val-humi">--</span><span class="stat-label">Humidity (%)</span></div>
            </div>
        </div>
        <div class="sb-section">
            <h3>Quick Navigation</h3>
            <ul class="room-list" id="room-list-ul">
                <!-- JSÂä®ÊÄÅÁîüÊàê -->
            </ul>
        </div>
    </div>

    <!-- ÁÅØÂÖâÊéßÂà∂Èù¢Êùø -->
    <div class="controls-panel" id="controls-panel">
        <div class="cp-header">
            <h4 class="cp-title" id="cp-room-name">Living Room</h4>
            <p class="cp-subtitle">Room Controls</p>
        </div>
        <!-- ÁÅØÂÖâË°å -->
        <div class="control-row" id="cp-light-row">
            <span class="control-label icon-light">Ceiling Light</span>
            <span class="status-text" id="cp-light-status">OFF</span>
        </div>
    </div>

    <!-- ‰∏ªÂÜÖÂÆπ -->
    <div id="main-wrapper">
        <div class="menu-btn" id="menu-btn">‚ò∞</div>
        <div class="theme-controls">
            <!-- [‰øÆÊîπ] Áªô theme-dawn Âä†‰∏ä active Á±ª -->
            <div class="theme-btn" id="theme-night" title="ÈùôË∞ß (Night)"><div class="color-dot" style="background: linear-gradient(135deg, #2f3640, #353b48);"></div></div>
            <div class="theme-btn" id="theme-dawn" title="ÂæÆËå´ (Dawn)"><div class="color-dot" style="background: linear-gradient(135deg, #718093, #7f8fa6);"></div></div>
            <div class="theme-btn" id="theme-dusk" title="‰ΩôÊôñ (Dusk)"><div class="color-dot" style="background: linear-gradient(135deg, #ba9e95, #d1ccc0);"></div></div>
        </div>
        <div class="tip" id="status-tip">Ê≠£Âú®ËøûÊé•‰∫ëÁ´Ø...</div>
        <div class="view-controls">
            <button class="view-btn" id="btn-2d">2D VIEW</button>
            <button class="view-btn active" id="btn-3d">3D VIEW</button>
        </div>
        <div id="mqtt-status">MQTT: Disconnected</div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- MQTT Config ---
        const MQTT_CONFIG = {
            host: 'wss://iot-06z00jbvofuz12n.mqtt.iothub.aliyuncs.com:443/mqtt',
            options: {
                clientId: 'hbqr9g5E5SA.Controller|securemode=2,signmethod=hmacsha256,timestamp=1765421639149|',
                username: 'Controller&hbqr9g5E5SA',
                password: 'd5dcc10240bd55af6b55122c0645e5c1ac2b1c882d826c89f95acb470b941905',
                keepalive: 60,
                clean: true
            },
            topics: {
                post: `/sys/hbqr9g5E5SA/Controller/thing/event/property/post`,
                set: `/sys/hbqr9g5E5SA/Controller/thing/service/property/set`
            }
        };

        const ROOM_PROP_MAP = {
            'Living_Room': 'LivingRoomLight',
            'Bedroom_Bottom_Left': 'MasterRoomLight',
            'Bedroom_Top_Left': 'GuestRoomLight1', 
            'Bedroom_Top_Right': 'GuestRoomLight2', 
            'Entrance': 'EntranceLiight'
        };

        // --- ÂÖ®Â±ÄÂèòÈáè ---
        const interactables = [];
        let activeRoomId = null;  
        let currentFocusedRoom = null; 
        let hoveredObject = null;
        let pointerDownX = 0;
        let pointerDownY = 0;
        let mqttClient = null;

        // --- UI Logic ---
        const sidebar = document.getElementById('sidebar');
        const menuBtn = document.getElementById('menu-btn');
        const mainWrapper = document.getElementById('main-wrapper');
        const statusTip = document.getElementById('status-tip');
        const mqttStatusDiv = document.getElementById('mqtt-status');
        
        const controlsPanel = document.getElementById('controls-panel');
        const cpTitle = document.getElementById('cp-room-name');
        const cpLightRow = document.getElementById('cp-light-row');
        const cpLightStatus = document.getElementById('cp-light-status');
        const valTemp = document.getElementById('val-temp');
        const valHumi = document.getElementById('val-humi');

        function updateTip(text) { 
            if (text && text.length > 0) {
                statusTip.innerText = text;
                statusTip.style.opacity = '1';
                statusTip.style.transform = 'translate(-50%, 0)';
            } else {
                statusTip.style.opacity = '0';
                statusTip.style.transform = 'translate(-50%, -10px)';
            }
        }

        // [Êñ∞Â¢û] ÁªëÂÆö UI ÊåâÈíÆÁöÑÊÇ¨ÂÅúÊèêÁ§∫
        function bindUITip(elementId, text) {
            const el = document.getElementById(elementId);
            if (el) {
                el.addEventListener('mouseenter', () => updateTip(text));
                el.addEventListener('mouseleave', () => updateTip("")); 
            }
        }

        bindUITip('theme-night', 'ÂàáÊç¢ÁéØÂ¢ÉÔºöÊ∑±Â§ú');
        bindUITip('theme-dawn', 'ÂàáÊç¢ÁéØÂ¢ÉÔºöÊ∏ÖÊô®');
        bindUITip('theme-dusk', 'ÂàáÊç¢ÁéØÂ¢ÉÔºöÈªÑÊòè');
        bindUITip('btn-2d', 'ÂàáÊç¢ËßÜÂõæÔºö2DÂπ≥Èù¢');
        bindUITip('btn-3d', 'ÂàáÊç¢ËßÜÂõæÔºö3DÁ´ã‰Ωì');
        bindUITip('menu-btn', 'Â±ïÂºÄ/Êî∂Ëµ∑‰æßËæπÊ†è');

        function toggleSidebar() {
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                document.body.classList.remove('sidebar-open');
                hideControlsPanel();
            } else {
                sidebar.classList.add('active');
                document.body.classList.add('sidebar-open');
            }
        }
        menuBtn.addEventListener('click', toggleSidebar);

        function updatePanelUI(roomId) {
            const lampMesh = interactables.find(obj => obj.userData.type === 'lamp' && obj.userData.roomId === roomId);
            if (lampMesh) {
                cpLightRow.style.display = 'flex';
                if (lampMesh.userData.isOn) {
                    cpLightRow.classList.add('active-state');
                    cpLightStatus.innerText = 'ON';
                } else {
                    cpLightRow.classList.remove('active-state');
                    cpLightStatus.innerText = 'OFF';
                }
            } else {
                cpLightRow.style.display = 'none';
            }
        }

        function showControlsPanel(roomId, roomDisplayName) {
            if (!sidebar.classList.contains('active')) return;
            cpTitle.innerText = roomDisplayName;
            activeRoomId = roomId;
            updatePanelUI(roomId);
            controlsPanel.classList.add('active');
            document.querySelectorAll('.room-item').forEach(el => {
                if(el.dataset.room === roomId) el.classList.add('selected');
                else el.classList.remove('selected');
            });
        }

        function hideControlsPanel() {
            controlsPanel.classList.remove('active');
            document.querySelectorAll('.room-item').forEach(el => el.classList.remove('selected'));
            activeRoomId = null;
        }

        cpLightRow.addEventListener('click', () => {
            if (!activeRoomId) return;
            const lampMesh = interactables.find(obj => obj.userData.type === 'lamp' && obj.userData.roomId === activeRoomId);
            if (lampMesh) toggleLampState(lampMesh, null, true);
        });

        // --- MQTT Logic ---
        function initMQTT() {
            console.log('Connecting to Aliyun IoT...');
            try {
                mqttClient = mqtt.connect(MQTT_CONFIG.host, MQTT_CONFIG.options);

                mqttClient.on('connect', () => {
                    console.log('MQTT Connected');
                    mqttStatusDiv.innerText = 'MQTT: Connected';
                    updateTip("‰∫ëÁ´ØÂ∑≤ËøûÊé•ÔºåÂèØËøõË°åÊéßÂà∂");
                    
                    mqttClient.subscribe(MQTT_CONFIG.topics.set, (err) => {
                        if (!err) console.log('Subscribed to:', MQTT_CONFIG.topics.set);
                    });
                });

                mqttClient.on('message', (topic, message) => {
                    if (topic === MQTT_CONFIG.topics.set) {
                        const payload = JSON.parse(message.toString());
                        console.log('Received:', payload);
                        handleCloudCommand(payload.params);
                    }
                });

                mqttClient.on('error', (err) => {
                    console.error('MQTT Error:', err);
                    mqttStatusDiv.innerText = 'MQTT: Error';
                });
            } catch (e) {
                console.error("MQTT Init Failed", e);
            }
        }

        function handleCloudCommand(params) {
            for (const key in params) {
                const roomId = Object.keys(ROOM_PROP_MAP).find(rId => ROOM_PROP_MAP[rId] === key);
                if (roomId) {
                    const lamp = interactables.find(obj => obj.userData.type === 'lamp' && obj.userData.roomId === roomId);
                    if (lamp) {
                        const targetState = params[key] === 1; 
                        if (lamp.userData.isOn !== targetState) {
                            toggleLampState(lamp, targetState, false); 
                        }
                    }
                }
            }
            if (params.temperature !== undefined) valTemp.innerText = params.temperature.toFixed(1) + "¬∞";
            if (params.Humidity !== undefined) valHumi.innerText = params.Humidity.toFixed(1) + "%";
        }

        function publishProperty(props) {
            if (!mqttClient || !mqttClient.connected) return;
            const payload = {
                id: Date.now().toString(),
                version: "1.0",
                params: props,
                method: "thing.event.property.post"
            };
            mqttClient.publish(MQTT_CONFIG.topics.post, JSON.stringify(payload));
        }

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        const themes = {
            night: { bg: 0x2f3640, sun: 0x6a89cc, ambientColor: 0x8297b5, ambient: 0.45, fogDensity: 0.025 },
            dawn: { bg: 0x718093, sun: 0xdff9fb, ambientColor: 0xffffff, ambient: 0.6, fogDensity: 0.015 },
            dusk: { bg: 0xba9e95, sun: 0xffaf91, ambientColor: 0xfff0e6, ambient: 0.5, fogDensity: 0.02 }
        };
        const initialTheme = themes.dawn;
        scene.background = new THREE.Color(initialTheme.bg);
        scene.fog = new THREE.FogExp2(initialTheme.bg, initialTheme.fogDensity);

        const camera = new THREE.PerspectiveCamera(35, mainWrapper.clientWidth / mainWrapper.clientHeight, 0.1, 200);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(mainWrapper.clientWidth, mainWrapper.clientHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = false; 
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.25; 
        mainWrapper.appendChild(renderer.domElement);

        // --- Materials ---
        const glassMat = new THREE.MeshStandardMaterial({ color: 0xffffff, metalness: 0.1, roughness: 0.6, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        const floorMat = new THREE.MeshStandardMaterial({ color: 0xfdfdfd, roughness: 0.8, metalness: 0.05 }); 
        const woodMat = new THREE.MeshStandardMaterial({ color: 0xccbba0, roughness: 0.9 });
        const clothMat = new THREE.MeshStandardMaterial({ color: 0x95a5a6, roughness: 1.0 });
        const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.7 }); 
        const darkMat = new THREE.MeshStandardMaterial({ color: 0x57606f, roughness: 0.7 });
        const lightFrameMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.4, metalness: 0.1 }); 
        const paleDoorMat = new THREE.MeshStandardMaterial({ color: 0xe8e0d5, roughness: 0.6 }); 
        const matteGrayMat = new THREE.MeshStandardMaterial({ color: 0x505050, roughness: 0.9, metalness: 0.1 });
        const hitboxMat = new THREE.MeshBasicMaterial({ color: 0x4cd964, transparent: true, opacity: 0.0, side: THREE.DoubleSide, depthWrite: false });

        // --- House Construction ---
        const house = new THREE.Group();
        scene.add(house);
        const base = new THREE.Mesh(new THREE.BoxGeometry(18, 0.2, 12), floorMat);
        base.position.y = -0.1; house.add(base);

        function createWall(w, h, d, x, z) {
            const y = h / 2; const geo = new THREE.BoxGeometry(w, h, d); const mesh = new THREE.Mesh(geo, glassMat); mesh.position.set(x, y, z); house.add(mesh);
        }
        const H = 2.6; const T = 0.2;
        createWall(18, H, T, 0, -6); createWall(8.3, H, T, -4.85, 6); createWall(8.3, H, T, 4.85, 6);
        createWall(T, H, 12, -9, 0); createWall(T, H, 12, 9, 0);  
        createWall(7, H, T, -5.5, 0); createWall(7, H, T, 5.5, 1);  
        createWall(T, H, 1.8, -2, 5.1); createWall(T, H, 5.6, -2, 0); createWall(T, H, 1.8, -2, -5.1);
        createWall(T, H, 2.8, 2, 4.6); createWall(T, H, 0.8, 2, 1.4);

        function createHeader(x, z, w, d) {
            const gapGeo = new THREE.BoxGeometry(w, 0.3, d); const gapMesh = new THREE.Mesh(gapGeo, glassMat); gapMesh.position.set(x, 2.45, z); house.add(gapMesh);
        }
        createHeader(0, 6, 1.4, T); createHeader(-2, 3.5, T, 1.4); createHeader(-2, -3.5, T, 1.4); createHeader(2, 2.5, T, 1.4);    

        const roomZones = []; 
        const rooms = [
            { name: 'Bedroom_Bottom_Left', label: 'Master Bedroom', x: -5.5, z: -3, w: 7, d: 6 },
            { name: 'Bedroom_Top_Left', label: 'Guest Room 1', x: -5.5, z: 3, w: 7, d: 6 },
            { name: 'Bedroom_Top_Right', label: 'Guest Room 2', x: 5.5, z: 3.5, w: 7, d: 5 },
            { name: 'Living_Room', label: 'Living Room', x: 5, z: -1.5, w: 7, d: 9 }, 
            { name: 'Entrance', label: 'Entrance', x: 0, z: 0, w: 4, d: 12 } 
        ];
        rooms.forEach(room => {
            const geo = new THREE.PlaneGeometry(room.w, room.d); const mesh = new THREE.Mesh(geo, hitboxMat);
            mesh.rotation.x = -Math.PI / 2; mesh.position.set(room.x, 0.05, room.z);
            mesh.userData = { type: 'room', roomData: room }; house.add(mesh); roomZones.push(mesh);
        });

        // ‰æßËæπÊ†èÂàóË°®
        const roomListUl = document.getElementById('room-list-ul');
        roomListUl.innerHTML = '';
        rooms.forEach(room => {
            const li = document.createElement('li');
            li.className = 'room-item';
            li.dataset.room = room.name;
            li.innerHTML = `<span>${room.label}</span> <span class="room-icon">‚Üí</span>`;
            li.addEventListener('click', (e) => {
                const targetRoom = rooms.find(r => r.name === room.name);
                if(targetRoom) {
                    if (currentMode !== '2d') {
                        updateView('2d');
                        setTimeout(() => zoomToRoom(targetRoom), 100);
                    } else {
                        zoomToRoom(targetRoom);
                    }
                    showControlsPanel(room.name, room.label);
                }
            });
            roomListUl.appendChild(li);
        });

        function toggleLampState(mesh, forceState = null, shouldPublish = true) {
            const data = mesh.userData;
            const light = data.lightRef;
            const newState = (forceState !== null) ? forceState : !data.isOn;
            data.isOn = newState;

            if (data.isOn) {
                gsap.to(mesh.material.emissive, { r: 1, g: 0.9, b: 0.7, duration: 0.4 });
                gsap.to(light, { intensity: data.intensityMax, duration: 0.6, ease: "power2.out" });
            } else {
                gsap.to(mesh.material.emissive, { r: 0, g: 0, b: 0, duration: 0.4 });
                gsap.to(light, { intensity: 0, duration: 0.4 });
            }
            if (activeRoomId === data.roomId) updatePanelUI(activeRoomId);

            if (shouldPublish && data.roomId && ROOM_PROP_MAP[data.roomId]) {
                const propName = ROOM_PROP_MAP[data.roomId];
                const props = {};
                props[propName] = data.isOn ? 1 : 0;
                publishProperty(props);
            }
        }

        function createInteractiveDoor(x, z, rotationY, mat, openDir = -1) {
            const group = new THREE.Group(); group.position.set(x, 0, z); group.rotation.y = rotationY;
            const frameDepth = 0.24; const sillHeight = 0.05;
            const sill = new THREE.Mesh(new THREE.BoxGeometry(1.4, sillHeight, 0.26), new THREE.MeshStandardMaterial({color: 0x999999})); sill.position.y = sillHeight / 2 + 0.001; group.add(sill);
            const sideHeight = 2.244; const sideY = 0.051 + sideHeight / 2;
            const frameLeft = new THREE.Mesh(new THREE.BoxGeometry(0.1, sideHeight, frameDepth), lightFrameMat); frameLeft.position.set(-0.65, sideY, 0); group.add(frameLeft);
            const frameRight = frameLeft.clone(); frameRight.position.set(0.65, sideY, 0); group.add(frameRight);
            const frameTop = new THREE.Mesh(new THREE.BoxGeometry(1.4, 0.095, frameDepth), lightFrameMat); frameTop.position.y = 2.25; group.add(frameTop);
            const doorPivot = new THREE.Group(); doorPivot.position.set(-0.6, 0, 0);
            const door = new THREE.Mesh(new THREE.BoxGeometry(1.2, 2.2, 0.08), mat); door.position.set(0.6, 1.1, 0); 
            const handle = new THREE.Mesh(new THREE.BoxGeometry(0.15, 0.03, 0.05), new THREE.MeshStandardMaterial({color: 0x555555})); handle.position.set(1.1, 1.0, 0.06); 
            doorPivot.add(door); doorPivot.add(handle); group.add(doorPivot);
            door.userData = { type: 'door', isOpen: false, pivot: doorPivot, openDir: openDir }; interactables.push(door); house.add(group);
        }
        createInteractiveDoor(0, 6, 0, matteGrayMat, -1); 
        createInteractiveDoor(-2, -3.5, Math.PI / 2, paleDoorMat, -1); 
        createInteractiveDoor(-2, 3.5, Math.PI / 2, paleDoorMat, -1); 
        createInteractiveDoor(2, 2.5, -Math.PI / 2, paleDoorMat, -1); 

        function createBed(x, z, rotationY = 0) {
            const g = new THREE.Group(); g.position.set(x, 0, z); g.rotation.y = rotationY;
            const f = new THREE.Mesh(new THREE.BoxGeometry(2, 0.4, 2.6), woodMat); f.position.y=0.2; g.add(f);
            const m = new THREE.Mesh(new THREE.BoxGeometry(1.9, 0.25, 2.5), whiteMat); m.position.y=0.52; g.add(m);
            const p = new THREE.Mesh(new THREE.SphereGeometry(0.35,16,16), clothMat); p.scale.set(1,0.4,0.6); p.position.set(-0.5,0.7,-0.9); g.add(p);
            const p2 = p.clone(); p2.position.set(0.5, 0.7, -0.9); g.add(p2);
            const h = new THREE.Mesh(new THREE.BoxGeometry(2,0.9,0.1), woodMat); h.position.set(0,0.45,-1.35); g.add(h);
            const ns1 = new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), woodMat); ns1.position.set(-1.4, 0.25, -1.15); g.add(ns1);
            const ns2 = ns1.clone(); ns2.position.set(1.4, 0.25, -1.15); g.add(ns2);
            house.add(g);
        }
        createBed(-5.5, -4.45, 0); createBed(-5.5, 4.45, Math.PI); createBed(5.5, 4.45, Math.PI);
        function createSofa(x, z, r) { const g = new THREE.Group(); g.position.set(x,0,z); g.rotation.y=r; const b = new THREE.Mesh(new THREE.BoxGeometry(3.5,0.4,1), clothMat); b.position.y=0.2; g.add(b); const bk = new THREE.Mesh(new THREE.BoxGeometry(3.5,0.6,0.2), clothMat); bk.position.set(0,0.5,-0.4); g.add(bk); const ar = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.5,1), clothMat); ar.position.set(-1.65,0.4,0); g.add(ar); const ar2 = ar.clone(); ar2.position.set(1.65,0.4,0); g.add(ar2); const c = new THREE.Mesh(new THREE.BoxGeometry(1.1,0.4,1.5), clothMat); c.position.set(1.2,0.2,0.75); g.add(c); house.add(g); }
        function createTable(x, z) { const g = new THREE.Group(); g.position.set(x,0,z); const t = new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,0.05,32), whiteMat); t.position.y=0.4; g.add(t); const l = new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.02,0.4,8), woodMat); l.position.set(-0.3,0.2,-0.3); g.add(l); const l2 = l.clone(); l2.position.set(0.3,0.2,-0.3); g.add(l2); const l3 = l.clone(); l3.position.set(0,0.2,0.3); g.add(l3); house.add(g); }
        createSofa(5, -3, 0); createTable(5, -1.5);
        const tv = new THREE.Mesh(new THREE.BoxGeometry(2.5,0.4,0.4), darkMat); tv.position.set(5, 0.2, 0.65); house.add(tv);

        function createCeilingLamp(x, z, type = 'round', scale = 1.0, roomId = null) {
            const group = new THREE.Group(); group.position.set(x, 2.45, z); group.scale.set(scale, scale, scale);
            let lampGeo = type === 'rect' ? new THREE.BoxGeometry(2.0, 0.1, 1.2) : new THREE.CylinderGeometry(0.6, 0.6, 0.1, 48);
            let intensityMax = type === 'rect' ? 12 : 8;
            const lampMat = new THREE.MeshStandardMaterial({ color: 0xfff5d7, emissive: 0x000000, roughness: 0.2, metalness: 0.1 });
            const lamp = new THREE.Mesh(lampGeo, lampMat);
            lamp.userData = { type: 'lamp', isOn: false, intensityMax: intensityMax, roomId: roomId }; group.add(lamp);
            const light = new THREE.PointLight(0xffaa33, 0, 35, 2.0); light.position.set(0, -0.2, 0); group.add(light);
            lamp.userData.lightRef = light; house.add(group); interactables.push(lamp);
        }
        createCeilingLamp(-5.5, -3.5, 'round', 1.0, 'Bedroom_Bottom_Left'); 
        createCeilingLamp(-5.5, 2.5, 'round', 1.0, 'Bedroom_Top_Left');  
        createCeilingLamp(5.5, 4.0, 'round', 1.0, 'Bedroom_Top_Right');   
        createCeilingLamp(5, -1.5, 'rect', 1.0, 'Living_Room'); 
        createCeilingLamp(0, 4.0, 'round', 0.6, 'Entrance');

        const ambientLight = new THREE.AmbientLight(initialTheme.ambientColor, initialTheme.ambient); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(initialTheme.sun, 1.3); dirLight.position.set(6, 20, 4); scene.add(dirLight);

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true; controls.dampingFactor = 0.05; controls.maxDistance = 60;
        
        let currentMode = '3d';
        const VIEW_HEIGHT_GLOBAL = 40; const VIEW_HEIGHT_ZOOM = 20;   
        camera.position.set(12, 14, 12); controls.target.set(0, 0, 0);

        function switchTheme(type) {
            const theme = themes[type];
            gsap.to(scene.background, { r: new THREE.Color(theme.bg).r, g: new THREE.Color(theme.bg).g, b: new THREE.Color(theme.bg).b, duration: 1.5 });
            gsap.to(scene.fog.color, { r: new THREE.Color(theme.bg).r, g: new THREE.Color(theme.bg).g, b: new THREE.Color(theme.bg).b, duration: 1.5 });
            gsap.to(scene.fog, { density: theme.fogDensity, duration: 1.5 });
            gsap.to(dirLight.color, { r: new THREE.Color(theme.sun).r, g: new THREE.Color(theme.sun).g, b: new THREE.Color(theme.sun).b, duration: 1.5 });
            gsap.to(ambientLight.color, { r: new THREE.Color(theme.ambientColor).r, g: new THREE.Color(theme.ambientColor).g, b: new THREE.Color(theme.ambientColor).b, duration: 1.5 });
            gsap.to(ambientLight, { intensity: theme.ambient, duration: 1.5 });
            document.querySelectorAll('.theme-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`theme-${type}`).classList.add('active');
        }

        // [Ê†∏ÂøÉ] ËøõÂÖ•Â±ÄÈÉ® 3D ËßÜÂõæ
        function enterLocal3D(room) {
            currentMode = '3d'; 
            document.getElementById('btn-3d').classList.add('active');
            document.getElementById('btn-2d').classList.remove('active');
            
            controls.minPolarAngle = 0; 
            controls.maxPolarAngle = Math.PI - 0.1; 
            controls.enableRotate = true;

            roomZones.forEach(z => z.visible = true); 

            gsap.to(controls.target, { x: room.x, y: 0, z: room.z, duration: 1.6, ease: "power3.inOut" });

            const offset = new THREE.Vector3().subVectors(camera.position, controls.target);
            offset.y = 0;
            if (offset.lengthSq() < 0.001) offset.set(0, 0, 1);
            offset.normalize();
            offset.applyAxisAngle(new THREE.Vector3(0,1,0), Math.PI / 8); 

            gsap.to(camera.position, { 
                x: room.x + offset.x * 9,
                y: 8,
                z: room.z + offset.z * 9, 
                duration: 1.6, 
                ease: "power3.inOut"
            });
            
            updateTip(`Â∑≤ËøõÂÖ• ${room.label} 3DËßÜÂõæÔºåÁÇπÂáªÂÖ∂‰ªñÊàøÈó¥ÂàáÊç¢`);
            currentFocusedRoom = room.name;
        }

        function zoomToRoom(room) {
            currentFocusedRoom = room.name;
            updateTip(`ÂÜçÊ¨°ÁÇπÂáª ${room.label} ÂèØËøõÂÖ•3DËßÜÂõæ`);
            gsap.to(controls.target, { x: room.x, y: 0, z: room.z, duration: 1.2, ease: "power2.inOut" });
            const currentAngle = controls.getAzimuthalAngle();
            const snapAngle = Math.round(currentAngle / (Math.PI / 2)) * (Math.PI / 2);
            const offsetR = 0.01; const camX = room.x + Math.sin(snapAngle) * offsetR; const camZ = room.z + Math.cos(snapAngle) * offsetR;
            gsap.to(camera.position, { x: camX, y: VIEW_HEIGHT_ZOOM, z: camZ, duration: 1.2, ease: "power2.inOut",
                onComplete: () => { if (currentMode === '2d') { controls.minPolarAngle = 0; controls.maxPolarAngle = 0.2; } }
            });
        }

        function updateView(mode) {
            currentFocusedRoom = null;
            if (mode === '2d') {
                currentMode = '2d';
                document.getElementById('btn-2d').classList.add('active'); document.getElementById('btn-3d').classList.remove('active');
                roomZones.forEach(z => z.visible = true);
                controls.minPolarAngle = 0; controls.maxPolarAngle = 0.2; controls.enableRotate = true; 
                gsap.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.2, ease: "power2.inOut" });
                const angle = controls.getAzimuthalAngle(); const r = 0.1; 
                const snapAngle = Math.round(angle / (Math.PI / 2)) * (Math.PI / 2);
                gsap.to(camera.position, { x: Math.sin(snapAngle) * r, y: VIEW_HEIGHT_GLOBAL, z: Math.cos(snapAngle) * r, duration: 1.2, ease: "power2.inOut"});
                updateTip("2DÊ®°ÂºèÔºöÁÇπÂáªÊàøÈó¥ÊîæÂ§ßÔºåÂÜçÊ¨°ÁÇπÂáªËøõÂÖ•3D");
            } else {
                currentMode = '3d';
                document.getElementById('btn-3d').classList.add('active'); document.getElementById('btn-2d').classList.remove('active');
                roomZones.forEach(z => z.visible = true);
                controls.minPolarAngle = 0; controls.maxPolarAngle = Math.PI/2 - 0.05; controls.enableRotate = true;
                gsap.to(controls.target, { x: 0, y: 0, z: 0, duration: 1.2, ease: "power2.inOut" });
                gsap.to(camera.position, { x: 12, y: 14, z: 12, duration: 1.2, ease: "power2.inOut" });
                updateTip("3DÊ®°ÂºèÔºöÁÇπÂáªÊàøÈó¥Áõ¥Êé•Êº´Ê∏∏ÔºåÊãñÂä®ÊóãËΩ¨");
            }
        }

        const raycaster = new THREE.Raycaster();
        const pointer = new THREE.Vector2();

        window.addEventListener('dblclick', (event) => {
            if (event.target.closest('.sidebar') || event.target.closest('.controls-panel')) return;
            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            const hits = raycaster.intersectObjects([...interactables, ...roomZones]);
            if (hits.length === 0) updateView(currentMode);
        });

        window.addEventListener('pointerdown', (event) => {
             pointerDownX = event.clientX;
             pointerDownY = event.clientY;
        });

        window.addEventListener('pointerup', (event) => {
            const deltaX = Math.abs(event.clientX - pointerDownX);
            const deltaY = Math.abs(event.clientY - pointerDownY);
            if (deltaX > 5 || deltaY > 5) return;

            if (!event.target.closest('.controls-panel') && !event.target.closest('.sidebar') && !event.target.closest('.room-item')) hideControlsPanel();
            if (event.target.closest('.sidebar') || event.target.closest('.menu-btn') || event.target.closest('.theme-controls') || event.target.closest('.view-controls') || event.target.closest('.controls-panel')) return;
            
            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(pointer, camera);
            const intersectsObj = raycaster.intersectObjects(interactables);
            if (intersectsObj.length > 0) {
                const target = intersectsObj[0].object;
                if (target.userData.type === 'door') {
                    const data = target.userData; data.isOpen = !data.isOpen;
                    const angle = data.openDir * Math.PI / 2;
                    gsap.to(data.pivot.rotation, { y: data.isOpen ? angle : 0, duration: 1.0, ease: "power2.inOut" });
                } else if (target.userData.type === 'lamp') {
                    toggleLampState(target, null, true);
                }
                return; 
            }

            const intersectsRoom = raycaster.intersectObjects(roomZones);
            if (intersectsRoom.length > 0) {
                const roomData = intersectsRoom[0].object.userData.roomData;
                
                if (currentMode === '2d') {
                    if (currentFocusedRoom === roomData.name) {
                        enterLocal3D(roomData);
                    } else {
                        zoomToRoom(roomData);
                        showControlsPanel(roomData.name, roomData.label);
                    }
                } else {
                    // 3D Ê®°Âºè (ÂÖ®Â±ÄÊàñÂ±ÄÈÉ®)ÔºöÁõ¥Êé•ËøõÂ±ÄÈÉ® 3D
                    enterLocal3D(roomData);
                    showControlsPanel(roomData.name, roomData.label);
                }
            }
        });

        window.addEventListener('pointermove', (event) => {
            const rect = renderer.domElement.getBoundingClientRect();
            pointer.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            pointer.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
            raycaster.setFromCamera(pointer, camera);
            
            let hit = false;
            let tooltipText = "";

            const objHits = raycaster.intersectObjects(interactables);
            if (objHits.length > 0) {
                hit = true;
                const obj = objHits[0].object;
                if (hoveredObject && hoveredObject !== obj) {
                    if (hoveredObject.material.emissive) hoveredObject.material.emissive.setHex(0x000000); 
                }
                hoveredObject = obj;
                if (obj.userData.type === 'door') tooltipText = obj.userData.isOpen ? "ÁÇπÂáªÂÖ≥Èó®" : "ÁÇπÂáªÂºÄÈó®";
                else if (obj.userData.type === 'lamp') {
                    tooltipText = obj.userData.isOn ? "ÁÇπÂáªÂÖ≥ÁÅØ" : "ÁÇπÂáªÂºÄÁÅØ";
                    if (!obj.userData.isOn) obj.material.emissive.setHex(0x333333); 
                }
            } else {
                if (hoveredObject) {
                    if (hoveredObject.userData.type === 'lamp' && !hoveredObject.userData.isOn) hoveredObject.material.emissive.setHex(0x000000);
                    hoveredObject = null;
                }
            }

            if (!hit) {
                const roomHits = raycaster.intersectObjects(roomZones);
                if (roomHits.length > 0) {
                    hit = true;
                    const room = roomHits[0].object;
                    room.material.opacity = 0.2; 
                    
                    const rName = room.userData.roomData.label;
                    if (currentMode === '2d') {
                        if (currentFocusedRoom === room.userData.roomData.name) {
                            tooltipText = `ÂÜçÊ¨°ÁÇπÂáªËøõÂÖ• ${rName} 3DËßÜÂõæ`;
                        } else {
                            tooltipText = `ÁÇπÂáªÊîæÂ§ß ${rName}`;
                        }
                    } else {
                        tooltipText = `ÁÇπÂáªËøõÂÖ• ${rName} ËßÜÂõæ`;
                    }
                    
                    roomZones.forEach(r => { if(r !== room) r.material.opacity = 0.0; });
                } else {
                    roomZones.forEach(r => r.material.opacity = 0.0);
                }
            }

            document.body.style.cursor = hit ? 'pointer' : 'default';
            if (tooltipText) updateTip(tooltipText);
        });

        // [‰øÆÂ§ç] ËÆæÁΩÆÂàùÂßãÊøÄÊ¥ªÁöÑÊåâÈíÆÁä∂ÊÄÅ
        document.getElementById('theme-dawn').classList.add('active');

        document.getElementById('theme-night').addEventListener('click', () => switchTheme('night'));
        document.getElementById('theme-dawn').addEventListener('click', () => switchTheme('dawn'));
        document.getElementById('theme-dusk').addEventListener('click', () => switchTheme('dusk'));
        document.getElementById('btn-2d').addEventListener('click', (e) => updateView('2d'));
        document.getElementById('btn-3d').addEventListener('click', (e) => updateView('3d'));

        function resizeRenderer() {
            const w = mainWrapper.clientWidth;
            const h = mainWrapper.clientHeight;
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
            renderer.setSize(w, h);
        }
        window.addEventListener('resize', resizeRenderer);
        mainWrapper.addEventListener('transitionend', resizeRenderer);
        
        function animate() {
            requestAnimationFrame(animate);
            if (renderer.domElement.width !== mainWrapper.clientWidth || renderer.domElement.height !== mainWrapper.clientHeight) {
                resizeRenderer();
            }
            controls.update();
            renderer.render(scene, camera);
        }

        initMQTT();
        animate();

    </script>
</body>
</html>